<!DOCTYPE html>
<html>
	<head>
		<style>
			canvas {
				border: 1px solid black;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas" height="300" width="300"></canvas>
	</body>
	<script>
		var canvas = document.getElementById("canvas");
		var context = canvas.getContext('2d');
		var m = [1, 0, 0, 1, 0, 0];
		var lastMatrix = [];

		function draw() {
			context.fillRect(25, 25, 100, 100);
		}

		function matrixScale(sx, sy) {
			m[0] *= sx;
				m[1] *= sx;
				m[2] *= sy;
				m[3] *= sy;
				console.log(m,'scale');
			}
	  
			function matrixSave() {
				lastMatrix.push(m);
			}
	  
			function matrixRestore(){
				m = lastMatrix.pop();
			}

			function transformPoint(px, py) {
				var x = px;
				var y = py;
				px = x * m[0] + y * m[2] + m[4];
				py = x * m[1] + y * m[3] + m[5];
				return {
				x: px,
				y: py
				}
			}
	  
			function matrixTranslate(x, y) {
				m[4] += m[0] * x + m[2] * y;
				m[5] += m[1] * x + m[3] * y;
				console.log(m,'translate');
				//dragStart = dragEnd;
			}
	  
			function clear() {
				context.save();
				context.setTransform(1, 0, 0, 1, 0, 0);
				context.clearRect(0, 0, canvas.width, canvas.height);
				context.restore();
			}
			var drag = false;
			var dragStart;
			var dragEnd;
			draw()
			canvas.addEventListener('mousedown', function(event) {
				var cit = transformPoint(event.pageX , event.pageY );
				dragStart = {
				x: cit.x - canvas.offsetLeft,
				y: cit.y - canvas.offsetTop
				}

				drag = true;

			})
	
			canvas.addEventListener('mousemove', function(event) {
				if (drag) {
					var cit = transformPoint(event.pageX , event.pageY );
					dragEnd = {
						x: cit.x - canvas.offsetLeft,
						y: cit.y - canvas.offsetTop
					}
					console.log(m,'prima trans');
					matrixTranslate(dragEnd.x - dragStart.x, dragEnd.y - dragStart.y)
					context.setTransform(m[0],0,0,m[3], dragEnd.x - dragStart.x, dragEnd.y - dragStart.y);
					console.log(m,'after trans');
					clear()
					draw()
					dragStart = dragEnd
				}
			})

			canvas.addEventListener('mouseup', function(event) {
				drag = false;
			})
	
	</script>
</html>